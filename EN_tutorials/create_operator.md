# Create Operator to implement custom model

Phantoscope is a cloud-native image search engine based on Milvus and deep learning. We know that the VGG16 model is used in the [Phantscope Quick Start](https://github.com/zilliztech/phantoscope/tree/0.1.0/docs/site/en/quickstart) to get a representation of the image feature vector. Then if you want to switch to a more accurate ResNet model to [customize the Operator](https://github.com/zilliztech/phantoscope/blob/0.1.0/operators/HowToAddAnOperator_en.md), how should this be achieved?

Since Phantoscope is fully compatible with mainstream deep learning frameworks such as Tensorflow, Pytorch, TensorRT, ONNX, XGBoost, etc., you can refer to this tutorial if you want to use your own deep learning model.

## 1. Preparation

- Some experience with Python

- Understand gRPC and protobuf

- Master basic Docker commands

- Familiarity with [Phantoscop basics](https://github.com/zilliztech/phantoscope/tree/0.1.0#phantoscope-basics)

- Run [Phantscop Quick Start](https://github.com/zilliztech/phantoscope/tree/0.1.0/docs/site/en/quickstart) successfully , to check the status of all containers:

```shell
$ docker-compose ps
# You are expected to see the following output
 Name                   Command                          State   Ports
 -----------------------------------------------------------------------------------------
 phantoscope_api_1      /usr/bin/gunicorn3 -w 4 -b ...   Up      0.0.0.0:5000->5000/tcp
 phantoscope_milvus_1   /var/lib/milvus/docker-ent ...   Up      0.0.0.0:19530->19530/tcp, 0.0.0.0:8080->8080/tcp
 phantoscope_minio_1    /usr/bin/docker-entrypoint ...   Up      0.0.0.0:9000->9000/tcp
 phantoscope_mysql_1    docker-entrypoint.sh mysqld      Up      0.0.0.0:3306->3306/tcp
 phantoscope_vgg_1      python3 server.py                Up      0.0.0.0:50001->50001/tcp
```




## 2. Customize Operator

The next step is to implement a custom Operator implementation based on the ResNet algorithm. The most basic Operator structure is shown in the **phantoscope/operators/example-custom-operaotor** directory:

1. Scripts for downloading the model files are usually stored in the **data** directory and used to download the model when making the mirror image.
2. Under the **rpc** directory is the python file generated by gRPC.
3. The **server** file in the home directory is usually used to store the gRPC server's associated logic.
4. The **custom_operator** file in the home directory is used to implement the interface required by the rpc file.

We will create Operator implementations of custom resnet50-encoder models based on this structure.

### 2.1 Create Directory

Create **resnet50-encoder** directory based on **example-custom-operaotor** content:

```bash
$ cp -rf example-custom-operator resnet50-encoder
$ cd resnet50-encoder
```

### 2.2 Customize Model

#### 2.2.1 Download Model

- Edit the **data/prepare_model.sh** script. Download the model via the `wget` command.

```bash
file=resnet50_weights_tf_dim_ordering_tf_kernels_notop.h5
url=https://github.com/fchollet/deep-learning-models/releases/download/v0.1/resnet50_weights_tf_dim_ordering_tf_kernels_notop.h5

if [[ ! -f "${file}" ]]; then
   echo "[INFO] Model tar package does not exist, begin to download..."
   wget ${url} -O ${file}
   echo "[INFO] Model tar package download successfully!"
fi

if [[ -f "${file}" ]];then
   echo "[INFO] Model has been prepared successfully!"
   exit 0
fi
```

  > Make sure to run the script to download the model file. If you are using your own model, change the `file` and `url` parameters in the script to your own model name and download address.

#### 2.2.2 Customize Operator

- Description of the interface implemented in **custom_operator.py**：

| Function | Description |
| -------------- | ----------- |
| __ init __(self) | Initialize functions |
| run(self, images, urls) | The model encode function, whose parameters include an image file or image urls <br />The function returns a feature vector whose result is that the model converts the image to a list type. |
| name(self) | Return the name of a custom Operator. |
| type(self) | Return a custom Operator type, such as encoder or processor. |
| input(self) | Return model input for a custom Operator, such as image. |
| output(self) | Return the model output of a custom Operator, such as a vector. |
| dimension(self) | Return the dimension of a custom Operator's model output vector, such as 2048. |
| metric_type(self) | Return the model metric of a custom Operator, such as L2 (Euclidean distance). |

- This article customizes the `CustomOperator` based on the ResNet50 model, refer to this [resnet50_custom_operator.py](./script/custom_operator.py) code:

```bash
# download custom_operator.py to resnet50-encoder floder
$ mv custom_operator.py custom_operator.py.bak
$ wget https://raw.githubusercontent.com/zilliztech/phantoscope-bootcamp/master/tutorials/script/custom_operator.py
```

- 根据 **custom_operator.py** 代码添加相关依赖，在 **requirements.txt, requirements-gpu.txt** 中添加：

```bash
Keras==2.3.1
tensorflow==1.14.0
grpcio==1.27.2
pillow
```

  > 如果你使用自己的模型，请修改 custom_operator.py 中的接口函数和 requirements.txt 中的相关依赖。

#### 2.2.3 Adjust the gRPC service

**server.py** 文件实现对自定义 Operator 的调用逻辑，我们需要根据自己定义的 Operator 类型调整 gRPC 服务，本文实现的是基于 ResNet 的 encoder 方法，那么将删除关于 processor 的代码模块：

```bash
# download server.py to resnet50-encoder floder
$ mv server.py server.py.bak
$ wget https://raw.githubusercontent.com/zilliztech/phantoscope-bootcamp/master/tutorials/script/server.py
```

> 如果你的模型实现的功能是 processor 类型，那么应该删除 encoder 的相关代码。 

### 2.3 构建 Docker 镜像

综上，通过修改 **data**、**server** 和 **custom_operator** 文件自定义了一个 Operactor 结构，接下来将运行 `make cpu` 命令构建自定义 Operator 的 Docker 镜像：

```bash
$ mv Makefile Makefile.bak
$ wget https://raw.githubusercontent.com/zilliztech/phantoscope-bootcamp/master/tutorials/script/Makefile
$ make cpu
```

我们可以在 **Makefile** 中修改 `IMAGE_NAME` 自定义镜像名称，例如 `resnet50_encoder`，那么通过运行 `docker images` 命令可以看到有一个名为 `psoperator/resnet50_encoder:latest` 的镜像。

### 2.4 启动容器并验证

- 启动容器

```bash
$ export LOCAL_ADDRESS=$(ip a | grep -Eo 'inet (addr:)?([0-9]*\.){3}[0-9]*' | grep -Eo '([0-9]*\.){3}[0-9]*' | grep -v '127.0.0.1'| head -n 1)
$ docker run -p 52001:52001 -e OP_ENDPOINT=${LOCAL_ADDRESS}:52001 -d psoperator/resnet50_encoder:latest
```

  该命令的参数介绍：

| 参数                                  | 描述                                                         |
| ------------------------------------- | ------------------------------------------------------------ |
| -p 52001:52001                        | -p 表示端口映射，将本机的 52001 端口映射到 Docker 中的52001端口 |
| -e OP_ENDPOINT=${LOCAL_ADDRESS}:52001 | -e 定义 Docker 的环境变量，容器的 OP_ENDPOINT 环境变量的端口需要与 -p 映射到本机的端口一致 |
| psoperator/resnet50_encoder:latest    | Docker 镜像名称，请修改为上一步自定义的镜像名                |

  容器启动后可以运行 `docker logs <resnet50_encoder container id>` 查看状态。

- 验证容器

```bash
# Download and run the test_operator.py
$ wget https://raw.githubusercontent.com/zilliztech/phantoscope-bootcamp/master/tutorials/script/test_custom_operator.py
$ python3 test_custom_operator.py -e ${LOCAL_ADDRESS}:52001
# You are expected to see the following output
INFO:root:Begin to test: endpoint-192.168.1.85:52001
INFO:root:Endpoint information: {'name': 'resnet50_encoder', 'endpoint': '192.168.1.85:52001', 'type': 'encoder', 'input': 'image', 'output': 'vector', 'dimension': '2048', 'metric_type': 'L2'}
INFO:root:Endpoint health: healthy
INFO:root:Result :
  vector size: 1;  data size: 0
INFO:root:  vector dim: 2048
INFO:root:All tests over.
```

> 运行测试脚本 -e 的参数与启动容器时的 `OP_ENDPOINT` 内容对应。
>
> 应该在启动容器后过约 3 分钟再运行验证代码，因为初始化 Operator 需要一些时间。



## 3. 注册 Operator

- 查看容器的运行状态，包括 [Phantoscope 快速开始](https://github.com/zilliztech/phantoscope/tree/0.1.0/docs/site/zh-CN/quickstart) 时启动的 5 个容器，以及上一步启动的自定义Operator 的容器。

```bash
$ docker ps
CONTAINER ID        IMAGE                                       COMMAND                  CREATED             STATUS              PORTS                                                NAMES
160fe088d86e        psoperator/resnet50_encoder:latest          "python3 server.py"      6 minutes ago       Up 6 minutes        80/tcp, 0.0.0.0:52001->52001/tcp                     bold_kilby
2fd3b14d3577        psoperator/vgg16:latest                     "python3 server.py"      10 minutes ago       Up 10 minutes           0.0.0.0:50001->50001/tcp                             phantoscope_vgg_1
5f48b00f1b6c        phantoscope/api-server:v0.1.0               "/usr/bin/gunicorn3 …"   10 minutes ago       Up 10 minutes           0.0.0.0:5000->5000/tcp                               phantoscope_api_1
0a96852998b2        mysql:5.6                                   "docker-entrypoint.s…"   10 minutes ago       Up 10 minutes           0.0.0.0:3306->3306/tcp                               phantoscope_mysql_1
a8a8291d5217        milvusdb/milvus:0.7.0-cpu-d031120-de409b    "/var/lib/milvus/doc…"   10 minutes ago       Up 10 minutes           0.0.0.0:8080->8080/tcp, 0.0.0.0:19530->19530/tcp     phantoscope_milvus_1
2c8f0dc350a7        minio/minio:latest                          "/usr/bin/docker-ent…"   10 minutes ago       Up 10 minutes           0.0.0.0:9000->9000/tcp                               phantoscope_minio_1
```

将 `resnet50-encoder` Operator 注册到 Phantoscope 中：

```bash
$ curl --location --request POST ${LOCAL_ADDRESS}':5000/v1/operator/regist' \
--header 'Content-Type: application/json' \
--data '{
    "endpoint": "'${LOCAL_ADDRESS}':52001",     
    "name": "resnet50_encoder"
}'
```

  > 端口 52001 是启动自定义 Operactor 容器时映射的端口。
  >
  >  `name` 参数 resnet50_encoder 是在 custom_operator.py 中定义的 Operator 名称。

  正确的运行结果会返回对应 Operator 的信息：

```bash
{"_name": "resnet50_encoder", "_backend": "resnet50_encoder", "_type": "encoder", "_input": "image", "_output": "vector", "_endpoint": "127.0.0.1:52001", "_metric_type": "L2", "_dimension": 2048}
```



## 4. 创建 Application

综上，我们已经将自定义的 Operator 注册到 Phantoscope 中了，接下来可以创建一个  Application 实现以图搜图，参考 [创建 Application](./create_application.md)。

> 在创建 Phantoscope Application 时我们已经在上一步完成了注册 Operator，这一步可跳过，而在接下来创建 Pipeline 时请**注意**修改 `encoder` 参数为 `resnet50_encoder`。



## 5. VGG 模型比对

本文实现了基于 ResNet 模型以图搜图，与 Vgg16 模型创建的 Application 搜索同一张图片的效果比对如下：

- Vgg 模型检索效果

![](../pic/vgg16.png)

- 自定义 Operator 检索效果（ResNet）

![](./pic/resnet50.png)

我们知道 Vgg 模型的准确率低于 ResNet，本文检索的效果也是后者更优。